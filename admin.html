<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Apni Duniya - Admin Panel</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Inter', sans-serif;
  background: #f5f7fa;
  color: #333;
}

/* HEADER */
.admin-header {
  background: linear-gradient(135deg, #2979ff 0%, #1a67e8 100%);
  color: white;
  padding: 20px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.header-top {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.admin-title {
  display: flex;
  align-items: center;
  gap: 12px;
  font-size: 24px;
  font-weight: 700;
}

.logout-btn {
  background: rgba(255,255,255,0.2);
  border: 1px solid rgba(255,255,255,0.3);
  color: white;
  padding: 10px 20px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: background 0.3s;
  font-weight: 500;
}

.logout-btn:hover {
  background: rgba(255,255,255,0.3);
}

.stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 15px;
  margin-top: 15px;
}

.stat-card {
  background: rgba(255,255,255,0.1);
  padding: 15px;
  border-radius: 10px;
  text-align: center;
  backdrop-filter: blur(10px);
}

.stat-number {
  font-size: 28px;
  font-weight: 700;
  margin-bottom: 5px;
}

.stat-label {
  font-size: 13px;
  opacity: 0.9;
}

/* MAIN CONTAINER */
.container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 20px;
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
}

@media (max-width: 1100px) {
  .container {
    grid-template-columns: 1fr;
  }
}

/* SECTIONS */
.section {
  background: white;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  margin-bottom: 20px;
}

.section-title {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 15px;
  border-bottom: 2px solid #f0f2f5;
}

.section-title h2 {
  font-size: 18px;
  color: #2979ff;
  display: flex;
  align-items: center;
  gap: 10px;
  font-weight: 600;
}

.action-btn {
  background: #f0f7ff;
  color: #2979ff;
  border: 1px solid #d1e3ff;
  padding: 8px 15px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 13px;
  display: flex;
  align-items: center;
  gap: 5px;
  transition: all 0.3s;
  font-weight: 500;
}

.action-btn:hover {
  background: #2979ff;
  color: white;
}

/* TABLES */
.table-container {
  overflow-x: auto;
}

.data-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}

.data-table th {
  background: #f8f9fa;
  color: #555;
  font-weight: 600;
  text-align: left;
  padding: 12px 15px;
  border-bottom: 2px solid #e9ecef;
}

.data-table td {
  padding: 12px 15px;
  border-bottom: 1px solid #eee;
  vertical-align: top;
}

.data-table tr:hover {
  background: #f8f9fa;
}

/* FORM ELEMENTS */
.form-group {
  margin-bottom: 15px;
}

.form-group label {
  display: block;
  font-size: 14px;
  font-weight: 500;
  margin-bottom: 8px;
  color: #555;
}

.form-control {
  width: 100%;
  padding: 10px 15px;
  border: 1px solid #ddd;
  border-radius: 8px;
  font-size: 14px;
  font-family: 'Inter', sans-serif;
  background: white;
}

.form-control:focus {
  outline: none;
  border-color: #2979ff;
  box-shadow: 0 0 0 2px rgba(41,121,255,0.1);
}

textarea.form-control {
  min-height: 100px;
  resize: vertical;
}

.checkbox-group {
  display: flex;
  align-items: center;
  gap: 10px;
  margin: 15px 0;
}

.checkbox-group input[type="checkbox"] {
  width: 18px;
  height: 18px;
  cursor: pointer;
}

.send-notification-btn {
  background: linear-gradient(135deg, #2979ff 0%, #1a67e8 100%);
  color: white;
  border: none;
  padding: 12px 20px;
  border-radius: 8px;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  transition: all 0.3s;
  margin-top: 10px;
}

.send-notification-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(41,121,255,0.3);
}

/* POST ACTIONS */
.post-actions {
  display: flex;
  gap: 8px;
}

.action-icon {
  width: 30px;
  height: 30px;
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.3s;
}

.edit-btn {
  background: #e7f3ff;
  color: #2979ff;
  border: 1px solid #c2dfff;
}

.edit-btn:hover {
  background: #2979ff;
  color: white;
}

.delete-btn {
  background: #ffeaea;
  color: #ff3b30;
  border: 1px solid #ffc7c7;
}

.delete-btn:hover {
  background: #ff3b30;
  color: white;
}

/* MODAL */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  z-index: 1000;
  justify-content: center;
  align-items: center;
  padding: 15px;
}

.modal-content {
  background: white;
  border-radius: 12px;
  width: 100%;
  max-width: 500px;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 10px 30px rgba(0,0,0,0.2);
}

.modal-header {
  background: #2979ff;
  color: white;
  padding: 20px;
  border-radius: 12px 12px 0 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-header h3 {
  font-size: 18px;
  display: flex;
  align-items: center;
  gap: 10px;
  font-weight: 600;
}

.close-modal {
  background: rgba(255,255,255,0.2);
  border: none;
  color: white;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
}

.modal-body {
  padding: 20px;
}

/* NOTIFICATIONS HISTORY */
.notification-item {
  background: #f8f9fa;
  border-radius: 8px;
  padding: 15px;
  margin-bottom: 10px;
  border-left: 4px solid #2979ff;
}

.notification-important {
  border-left-color: #ff9500;
}

.notification-meta {
  display: flex;
  justify-content: space-between;
  margin-top: 10px;
  font-size: 12px;
  color: #777;
}

.important-badge {
  background: #fff4e5;
  color: #ff9500;
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 11px;
  font-weight: 600;
}

/* LOADING */
.loading {
  text-align: center;
  padding: 30px;
  color: #777;
}

.loading i {
  font-size: 32px;
  margin-bottom: 10px;
  color: #ccc;
}

/* UTILITY */
.text-danger {
  color: #ff3b30;
}

.text-success {
  color: #34c759;
}

.text-warning {
  color: #ff9500;
}

.badge {
  padding: 3px 8px;
  border-radius: 4px;
  font-size: 11px;
  font-weight: 600;
}

.badge-success {
  background: #d4f8e8;
  color: #34c759;
}

.badge-warning {
  background: #fff4e5;
  color: #ff9500;
}

/* SCROLLBAR */
::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: #c1c1c1;
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: #a8a8a8;
}

/* TOAST STYLES */
.toast {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: #2979ff;
  color: white;
  padding: 14px 24px;
  border-radius: 12px;
  z-index: 9999;
  animation: fadeInOut 3s ease;
  font-weight: 500;
  box-shadow: 0 8px 25px rgba(41,121,255,0.3);
  max-width: 90%;
  text-align: center;
  font-size: 15px;
}

.toast-error {
  background: #ff3b30;
  box-shadow: 0 8px 25px rgba(255,59,48,0.3);
}

.toast-success {
  background: #34c759;
  box-shadow: 0 8px 25px rgba(52,199,89,0.3);
}

@keyframes fadeInOut {
  0% { opacity: 0; bottom: 0; transform: translateX(-50%) translateY(10px); }
  10% { opacity: 1; bottom: 20px; transform: translateX(-50%) translateY(0); }
  90% { opacity: 1; bottom: 20px; transform: translateX(-50%) translateY(0); }
  100% { opacity: 0; bottom: 0; transform: translateX(-50%) translateY(10px); }
}

@keyframes fadeOut {
  from { opacity: 1; }
  to { opacity: 0; }
}
</style>
</head>

<body>

<!-- HEADER -->
<header class="admin-header">
  <div class="header-top">
    <div class="admin-title">
      <i class="fas fa-user-shield"></i>
      Admin Panel
    </div>
    <button class="logout-btn" onclick="logout()">
      <i class="fas fa-sign-out-alt"></i>
      Logout
    </button>
  </div>
  
  <div class="stats">
    <div class="stat-card">
      <div class="stat-number" id="totalUsers">0</div>
      <div class="stat-label">Total Users</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="totalPosts">0</div>
      <div class="stat-label">Total Posts</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="totalLikes">0</div>
      <div class="stat-label">Total Likes</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="totalComments">0</div>
      <div class="stat-label">Total Comments</div>
    </div>
  </div>
</header>

<!-- MAIN CONTAINER -->
<div class="container">
  
  <!-- LEFT COLUMN -->
  <div class="left-column">
    
    <!-- USERS SECTION -->
    <div class="section">
      <div class="section-title">
        <h2><i class="fas fa-users"></i> All Users</h2>
      </div>
      <div class="table-container">
        <table class="data-table" id="usersTable">
          <thead>
            <tr>
              <th>Username</th>
              <th>Mobile</th>
              <th>Joined</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="usersList">
            <tr>
              <td colspan="4" class="loading">
                <i class="fas fa-spinner fa-spin"></i><br>
                Loading users...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- SEND NOTIFICATION SECTION -->
    <div class="section">
      <div class="section-title">
        <h2><i class="fas fa-bell"></i> Send Notification</h2>
      </div>
      
      <div class="form-group">
        <label for="notificationTitle">Title</label>
        <input type="text" id="notificationTitle" class="form-control" placeholder="Notification title">
      </div>
      
      <div class="form-group">
        <label for="notificationMessage">Message</label>
        <textarea id="notificationMessage" class="form-control" placeholder="Write notification message..."></textarea>
      </div>
      
      <div class="checkbox-group">
        <input type="checkbox" id="importantNotification">
        <label for="importantNotification">Mark as Important</label>
      </div>
      
      <button class="send-notification-btn" onclick="sendNotification()">
        <i class="fas fa-paper-plane"></i>
        Send Notification
      </button>
    </div>
    
    <!-- NOTIFICATIONS HISTORY -->
    <div class="section">
      <div class="section-title">
        <h2><i class="fas fa-history"></i> Notifications History</h2>
        <button class="action-btn" onclick="clearAllNotifications()">
          <i class="fas fa-trash"></i>
          Clear All
        </button>
      </div>
      <div id="notificationsHistory">
        <div class="loading">
          <i class="fas fa-spinner fa-spin"></i><br>
          Loading notifications...
        </div>
      </div>
    </div>
    
  </div>
  
  <!-- RIGHT COLUMN -->
  <div class="right-column">
    
    <!-- ALL POSTS SECTION -->
    <div class="section">
      <div class="section-title">
        <h2><i class="fas fa-file-alt"></i> All Posts</h2>
        <div class="action-btn" onclick="refreshPosts()">
          <i class="fas fa-sync-alt"></i>
          Refresh
        </div>
      </div>
      <div class="table-container">
        <table class="data-table" id="postsTable">
          <thead>
            <tr>
              <th>Title</th>
              <th>User</th>
              <th>Category</th>
              <th>Likes/Comments</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="postsList">
            <tr>
              <td colspan="5" class="loading">
                <i class="fas fa-spinner fa-spin"></i><br>
                Loading posts...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- POST ANALYTICS -->
    <div class="section">
      <div class="section-title">
        <h2><i class="fas fa-chart-bar"></i> Post Analytics</h2>
      </div>
      <div id="postAnalytics">
        <div class="loading">
          <i class="fas fa-spinner fa-spin"></i><br>
          Loading analytics...
        </div>
      </div>
    </div>
    
  </div>
</div>

<!-- EDIT POST MODAL -->
<div class="modal" id="editPostModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3><i class="fas fa-edit"></i> Edit Post</h3>
      <button class="close-modal" onclick="closeModal('editPostModal')">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label for="editPostTitle">Title</label>
        <input type="text" id="editPostTitle" class="form-control">
      </div>
      
      <div class="form-group">
        <label for="editPostCategory">Category</label>
        <select id="editPostCategory" class="form-control">
          <option value="Shayari">Shayari</option>
          <option value="Motivational">Motivational</option>
          <option value="Gajla">Gajla</option>
          <option value="Apni Duniya Shayari">Apni Duniya Shayari</option>
          <option value="Dosti">Dosti</option>
          <option value="Mohabbat">Mohabbat</option>
          <option value="Pyar">Pyar</option>
          <option value="Ishq">Ishq</option>
          <option value="Success">Success</option>
          <option value="Jindagi">Jindagi</option>
          <option value="Desh Bhakti">Desh Bhakti</option>
          <option value="Dard">Dard</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="editPostText">Content</label>
        <textarea id="editPostText" class="form-control" rows="6"></textarea>
      </div>
      
      <div class="form-group">
        <label for="editPostUser">User</label>
        <input type="text" id="editPostUser" class="form-control" disabled>
      </div>
      
      <input type="hidden" id="editPostId">
      <input type="hidden" id="editPostOriginalCategory">
      
      <button class="send-notification-btn" onclick="saveEditedPost()">
        <i class="fas fa-save"></i>
        Save Changes
      </button>
    </div>
  </div>
</div>

<script type="module">
import {initializeApp} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import {getDatabase, ref, get, remove, update, push, query, orderByChild, equalTo} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

const app = initializeApp({
  apiKey: "AIzaSyAHAQjn4sTuR9FiGF3ljRrFEMZQjsx-SHg",
  databaseURL: "https://apni-duniya-b53d7-default-rtdb.firebaseio.com"
});
const db = getDatabase(app);

// Check admin access
const adminUser = localStorage.getItem("adminUser");
if(!adminUser) {
  window.location.href = "index.html";
}

// Admin password
const ADMIN_PASSWORD = "admin123";

// LOGOUT
window.logout = () => {
  localStorage.removeItem("adminUser");
  window.location.href = "index.html";
};

// MODAL FUNCTIONS
window.openModal = (modalId) => {
  document.getElementById(modalId).style.display = 'flex';
};

window.closeModal = (modalId) => {
  document.getElementById(modalId).style.display = 'none';
};

// TOAST FUNCTION - FIXED (NO LOCALHOST)
function showToast(message, type = 'success') {
  const toast = document.createElement('div');
  toast.textContent = message;
  toast.className = `toast ${type === 'error' ? 'toast-error' : type === 'success' ? 'toast-success' : ''}`;
  
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.style.animation = 'fadeOut 0.5s ease forwards';
    setTimeout(() => {
      if(toast.parentNode) toast.remove();
    }, 500);
  }, 2500);
}

// LOAD ALL DATA
loadAllData();

async function loadAllData() {
  await Promise.all([
    loadUsers(),
    loadPosts(),
    loadNotifications(),
    loadStats()
  ]);
}

// LOAD USERS
async function loadUsers() {
  try {
    const usersRef = ref(db, "normalUsers");
    const snapshot = await get(usersRef);
    
    const usersList = document.getElementById('usersList');
    usersList.innerHTML = '';
    
    if(!snapshot.exists()) {
      usersList.innerHTML = `
        <tr>
          <td colspan="4" style="text-align:center;padding:30px;color:#777;">
            <i class="fas fa-user-slash" style="font-size:24px;margin-bottom:10px;display:block;"></i>
            No users found
          </td>
        </tr>`;
      return;
    }
    
    let users = [];
    snapshot.forEach(user => {
      users.push({
        id: user.key,
        ...user.val()
      });
    });
    
    users.sort((a, b) => b.timestamp - a.timestamp);
    
    users.forEach(user => {
      const date = new Date(user.timestamp);
      const formattedDate = date.toLocaleDateString('en-IN', {
        day: '2-digit',
        month: 'short',
        year: 'numeric'
      });
      
      usersList.innerHTML += `
        <tr>
          <td>
            <strong>${user.username}</strong>
            ${user.role === 'admin' ? '<span class="badge badge-warning">Admin</span>' : ''}
          </td>
          <td>${user.mobile}</td>
          <td>${formattedDate}</td>
          <td>
            <button class="action-btn" onclick="deleteUser('${user.id}', '${user.username}')" style="background:#ffeaea;color:#ff3b30;border-color:#ffc7c7;">
              <i class="fas fa-trash"></i>
              Remove
            </button>
          </td>
        </tr>`;
    });
    
    document.getElementById('totalUsers').textContent = users.length;
    
  } catch(error) {
    console.error("Error loading users:", error);
    document.getElementById('usersList').innerHTML = `
      <tr>
        <td colspan="4" style="text-align:center;color:#ff3b30;padding:20px;">
          Error loading users
        </td>
      </tr>`;
  }
}

// DELETE USER - FIXED TOAST MESSAGE
window.deleteUser = async (userId, username) => {
  if(!confirm(`Are you sure you want to delete user "${username}"?`)) return;
  
  try {
    await remove(ref(db, `normalUsers/${userId}`));
    showToast(`User "${username}" deleted successfully`, 'success');
    loadUsers();
  } catch(error) {
    console.error("Error deleting user:", error);
    showToast("Failed to delete user", 'error');
  }
};

// LOAD POSTS
async function loadPosts() {
  try {
    const categories = ["Shayari","Motivational","Gajla","Apni Duniya Shayari","Dosti","Mohabbat","Pyar","Ishq","Success","Jindagi","Desh Bhakti","Dard"];
    let allPosts = [];
    let totalLikes = 0;
    let totalComments = 0;
    
    for(const category of categories) {
      const postsRef = ref(db, `posts/${category}`);
      const snapshot = await get(postsRef);
      
      if(snapshot.exists()) {
        snapshot.forEach(post => {
          const postData = post.val();
          allPosts.push({
            id: post.key,
            category: category,
            ...postData
          });
          
          totalLikes += postData.likes || 0;
        });
      }
      
      const commentsRef = ref(db, `comments/${category}`);
      const commentsSnapshot = await get(commentsRef);
      if(commentsSnapshot.exists()) {
        commentsSnapshot.forEach(categoryComments => {
          categoryComments.forEach(comment => {
            totalComments++;
          });
        });
      }
    }
    
    allPosts.sort((a, b) => b.timestamp - a.timestamp);
    
    const postsList = document.getElementById('postsList');
    postsList.innerHTML = '';
    
    if(allPosts.length === 0) {
      postsList.innerHTML = `
        <tr>
          <td colspan="5" style="text-align:center;padding:30px;color:#777;">
            <i class="fas fa-feather" style="font-size:24px;margin-bottom:10px;display:block;"></i>
            No posts found
          </td>
        </tr>`;
      return;
    }
    
    allPosts.forEach(post => {
      const date = new Date(post.timestamp);
      const formattedDate = date.toLocaleDateString('en-IN', {
        day: '2-digit',
        month: 'short'
      });
      
      postsList.innerHTML += `
        <tr>
          <td>
            <strong>${post.title || 'Untitled'}</strong><br>
            <small style="color:#777;">${formattedDate}</small>
          </td>
          <td>${post.user || 'Unknown'}</td>
          <td><span class="badge badge-success">${post.category}</span></td>
          <td>
            <span class="text-warning"><i class="fas fa-heart"></i> ${post.likes || 0}</span><br>
            <small>Comments: ${post.commentCount || 0}</small>
          </td>
          <td>
            <div class="post-actions">
              <div class="action-icon edit-btn" onclick="openEditPostModal('${post.id}', '${post.category}')">
                <i class="fas fa-edit"></i>
              </div>
              <div class="action-icon delete-btn" onclick="deletePost('${post.id}', '${post.category}', '${post.title}')">
                <i class="fas fa-trash"></i>
              </div>
            </div>
          </td>
        </tr>`;
    });
    
    document.getElementById('totalPosts').textContent = allPosts.length;
    document.getElementById('totalLikes').textContent = totalLikes;
    document.getElementById('totalComments').textContent = totalComments;
    
    updatePostAnalytics(allPosts);
    
  } catch(error) {
    console.error("Error loading posts:", error);
    document.getElementById('postsList').innerHTML = `
      <tr>
        <td colspan="5" style="text-align:center;color:#ff3b30;padding:20px;">
          Error loading posts
        </td>
      </tr>`;
  }
}

// UPDATE POST ANALYTICS
function updatePostAnalytics(posts) {
  const analyticsDiv = document.getElementById('postAnalytics');
  
  const categoryCount = {};
  const userPosts = {};
  
  posts.forEach(post => {
    categoryCount[post.category] = (categoryCount[post.category] || 0) + 1;
    
    if(post.user) {
      userPosts[post.user] = (userPosts[post.user] || 0) + 1;
    }
  });
  
  const topCategories = Object.entries(categoryCount)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 5);
  
  const topUsers = Object.entries(userPosts)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 5);
  
  let html = `
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
      <div>
        <h4 style="margin-bottom: 10px; color: #555; font-size: 14px;">Top Categories</h4>`;
  
  topCategories.forEach(([category, count]) => {
    const percentage = Math.round((count / posts.length) * 100);
    html += `
      <div style="margin-bottom: 10px;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 13px;">
          <span>${category}</span>
          <span>${count} posts</span>
        </div>
        <div style="height: 6px; background: #f0f2f5; border-radius: 3px; overflow: hidden;">
          <div style="width: ${percentage}%; height: 100%; background: #2979ff; border-radius: 3px;"></div>
        </div>
      </div>`;
  });
  
  html += `
      </div>
      <div>
        <h4 style="margin-bottom: 10px; color: #555; font-size: 14px;">Top Contributors</h4>`;
  
  topUsers.forEach(([user, count]) => {
    html += `
      <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f0f2f5; font-size: 13px;">
        <span>${user}</span>
        <span>${count} posts</span>
      </div>`;
  });
  
  html += `
      </div>
    </div>
    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; font-size: 13px;">
      <div style="display: flex; justify-content: space-between;">
        <span>Total Posts:</span>
        <strong>${posts.length}</strong>
      </div>
      <div style="display: flex; justify-content: space-between; margin-top: 5px;">
        <span>Categories:</span>
        <strong>${Object.keys(categoryCount).length}</strong>
      </div>
      <div style="display: flex; justify-content: space-between; margin-top: 5px;">
        <span>Active Users:</span>
        <strong>${Object.keys(userPosts).length}</strong>
      </div>
    </div>`;
  
  analyticsDiv.innerHTML = html;
}

// OPEN EDIT POST MODAL
window.openEditPostModal = async (postId, category) => {
  try {
    const postRef = ref(db, `posts/${category}/${postId}`);
    const snapshot = await get(postRef);
    
    if(snapshot.exists()) {
      const post = snapshot.val();
      
      document.getElementById('editPostTitle').value = post.title || '';
      document.getElementById('editPostText').value = post.text || '';
      document.getElementById('editPostUser').value = post.user || '';
      document.getElementById('editPostId').value = postId;
      document.getElementById('editPostCategory').value = category;
      document.getElementById('editPostOriginalCategory').value = category;
      
      openModal('editPostModal');
    }
  } catch(error) {
    console.error("Error loading post:", error);
    showToast("Failed to load post", 'error');
  }
};

// SAVE EDITED POST - FIXED TOAST MESSAGE
window.saveEditedPost = async () => {
  const postId = document.getElementById('editPostId').value;
  const originalCategory = document.getElementById('editPostOriginalCategory').value;
  const newCategory = document.getElementById('editPostCategory').value;
  const title = document.getElementById('editPostTitle').value.trim();
  const text = document.getElementById('editPostText').value.trim();
  
  if(!title || !text) {
    showToast("Please fill all fields", 'error');
    return;
  }
  
  try {
    if(originalCategory !== newCategory) {
      const originalRef = ref(db, `posts/${originalCategory}/${postId}`);
      const snapshot = await get(originalRef);
      
      if(snapshot.exists()) {
        const postData = snapshot.val();
        
        postData.title = title;
        postData.text = text;
        
        await push(ref(db, `posts/${newCategory}`), postData);
        await remove(originalRef);
        
        const commentsRef = ref(db, `comments/${originalCategory}/${postId}`);
        const commentsSnapshot = await get(commentsRef);
        
        if(commentsSnapshot.exists()) {
          const comments = [];
          commentsSnapshot.forEach(comment => {
            comments.push({
              id: comment.key,
              ...comment.val()
            });
          });
          
          await remove(commentsRef);
          
          comments.forEach(async comment => {
            await push(ref(db, `comments/${newCategory}/${postId}`), {
              user: comment.user,
              text: comment.text,
              timestamp: comment.timestamp
            });
          });
        }
      }
    } else {
      await update(ref(db, `posts/${originalCategory}/${postId}`), {
        title: title,
        text: text,
        edited: true,
        editedAt: Date.now()
      });
    }
    
    closeModal('editPostModal');
    showToast("Post updated successfully", 'success');
    loadPosts();
    
  } catch(error) {
    console.error("Error updating post:", error);
    showToast("Failed to update post", 'error');
  }
};

// DELETE POST - FIXED TOAST MESSAGE
window.deletePost = async (postId, category, postTitle) => {
  if(!confirm(`Are you sure you want to delete post "${postTitle}"?`)) return;
  
  try {
    await remove(ref(db, `posts/${category}/${postId}`));
    await remove(ref(db, `comments/${category}/${postId}`));
    
    showToast("Post deleted successfully", 'success');
    loadPosts();
  } catch(error) {
    console.error("Error deleting post:", error);
    showToast("Failed to delete post", 'error');
  }
};

// LOAD NOTIFICATIONS
async function loadNotifications() {
  try {
    const notificationsRef = ref(db, "notifications");
    const snapshot = await get(notificationsRef);
    
    const notificationsDiv = document.getElementById('notificationsHistory');
    
    if(!snapshot.exists()) {
      notificationsDiv.innerHTML = `
        <div style="text-align:center;padding:30px;color:#777;">
          <i class="fas fa-bell-slash" style="font-size:24px;margin-bottom:10px;display:block;"></i>
          No notifications sent yet
        </div>`;
      return;
    }
    
    let notifications = [];
    snapshot.forEach(notification => {
      notifications.push({
        id: notification.key,
        ...notification.val()
      });
    });
    
    notifications.sort((a, b) => b.timestamp - a.timestamp);
    
    let html = '';
    notifications.forEach(notif => {
      const date = new Date(notif.timestamp);
      const formattedDate = date.toLocaleDateString('en-IN', {
        day: '2-digit',
        month: 'short',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
      
      const isImportant = notif.important || notif.type === 'important';
      
      html += `
        <div class="notification-item ${isImportant ? 'notification-important' : ''}">
          <div class="notification-title">${notif.title || notif.type}</div>
          <div class="notification-message">${notif.message}</div>
          <div class="notification-meta">
            <span>${formattedDate}</span>
            ${isImportant ? '<span class="important-badge">Important</span>' : ''}
          </div>
        </div>`;
    });
    
    notificationsDiv.innerHTML = html;
    
  } catch(error) {
    console.error("Error loading notifications:", error);
    document.getElementById('notificationsHistory').innerHTML = `
      <div style="text-align:center;color:#ff3b30;padding:20px;">
        Failed to load notifications
      </div>`;
  }
}

// SEND NOTIFICATION - FIXED TOAST MESSAGE
window.sendNotification = async () => {
  const title = document.getElementById('notificationTitle').value.trim();
  const message = document.getElementById('notificationMessage').value.trim();
  const isImportant = document.getElementById('importantNotification').checked;
  
  if(!title || !message) {
    showToast("Please fill title and message", 'error');
    return;
  }
  
  try {
    await push(ref(db, "notifications"), {
      title: title,
      message: message,
      important: isImportant,
      timestamp: Date.now(),
      sentBy: "admin"
    });
    
    document.getElementById('notificationTitle').value = '';
    document.getElementById('notificationMessage').value = '';
    document.getElementById('importantNotification').checked = false;
    
    showToast("Notification sent successfully", 'success');
    loadNotifications();
    
  } catch(error) {
    console.error("Error sending notification:", error);
    showToast("Failed to send notification", 'error');
  }
};

// CLEAR ALL NOTIFICATIONS - FIXED TOAST MESSAGE
window.clearAllNotifications = async () => {
  if(!confirm("Are you sure you want to clear all notifications?")) return;
  
  try {
    await remove(ref(db, "notifications"));
    showToast("All notifications cleared", 'success');
    loadNotifications();
  } catch(error) {
    console.error("Error clearing notifications:", error);
    showToast("Failed to clear notifications", 'error');
  }
};

// LOAD STATS
async function loadStats() {
  // Stats are already loaded in loadUsers and loadPosts functions
}

// REFRESH POSTS - FIXED TOAST MESSAGE
window.refreshPosts = () => {
  loadPosts();
  showToast("Posts refreshed", 'success');
};

</script>
</body>
</html>